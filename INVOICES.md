# Формирование и отправка счетов на оплату аренды

## Описание функциональности

Система позволяет автоматически формировать счета на оплату аренды для арендаторов и отправлять их на email.

## Возможности

- ✅ Автоматическое формирование счета на основе данных договора
- ✅ Генерация HTML и PDF версий счета
- ✅ Отправка счета на email арендатора
- ✅ Красивый шаблон счета с реквизитами
- ✅ Автоматическое заполнение данных арендатора и объекта

## Как использовать

1. Перейдите в раздел **"Договоры"**
2. Найдите активный договор аренды
3. Нажмите кнопку **"Сформировать счет"** (зеленая кнопка)
4. В открывшемся окне:
   - Проверьте данные договора
   - Укажите период оплаты (например: "январь 2026") или оставьте пустым для текущего месяца
   - Отметьте чекбокс "Отправить счет на email арендатора" (если у арендатора указан email)
5. Нажмите **"Сформировать и отправить"**

Система автоматически:
- Сформирует счет с уникальным номером
- Откроет HTML версию в новом окне браузера
- Скачает PDF версию счета
- Отправит счет на email арендатора (если включена опция)

## Настройка отправки email

### Для разработки (тестовый режим)

По умолчанию система использует тестовый транспортер. Для реальной отправки email необходимо настроить SMTP сервер.

### Для production

Создайте файл `.env` в папке `backend` и добавьте настройки SMTP:

```env
# SMTP настройки для отправки email
SMTP_HOST=smtp.yandex.ru
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@yandex.ru
SMTP_PASS=your-app-password
SMTP_FROM=noreply@yourdomain.com

# Данные компании для счетов
COMPANY_NAME=ООО "Ваша Компания"
COMPANY_ADDRESS=г. Москва, ул. Примерная, д. 1
COMPANY_TAX_ID=1234567890
```

### Примеры настройки популярных почтовых сервисов

#### Яндекс.Почта
```env
SMTP_HOST=smtp.yandex.ru
SMTP_PORT=465
SMTP_SECURE=true
SMTP_USER=your-email@yandex.ru
SMTP_PASS=your-app-password  # Используйте пароль приложения, не основной пароль
SMTP_FROM=your-email@yandex.ru
```

#### Gmail
```env
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password  # Используйте пароль приложения
SMTP_FROM=your-email@gmail.com
```

#### Mail.ru
```env
SMTP_HOST=smtp.mail.ru
SMTP_PORT=465
SMTP_SECURE=true
SMTP_USER=your-email@mail.ru
SMTP_PASS=your-password
SMTP_FROM=your-email@mail.ru
```

### Как получить пароль приложения

**Яндекс:**
1. Перейдите в [Настройки аккаунта](https://id.yandex.ru/security)
2. Раздел "Пароли приложений"
3. Создайте новый пароль для "Почта"

**Gmail:**
1. Перейдите в [Настройки аккаунта Google](https://myaccount.google.com/apppasswords)
2. Создайте пароль приложения для "Почта"

## Структура счета

Счет включает:
- Номер счета (уникальный)
- Дату формирования
- Срок оплаты (автоматически +14 дней)
- Данные плательщика (арендатора)
- Данные объекта и помещения
- Период оплаты
- Сумму арендной платы
- Реквизиты для оплаты (настраиваются в шаблоне)

## API Endpoint

### POST /api/invoices/generate

**Тело запроса:**
```json
{
  "leaseId": 1,
  "period": "январь 2026",
  "sendEmail": true
}
```

**Ответ:**
```json
{
  "success": true,
  "invoice": {
    "number": "INV-1-1234567890",
    "date": "16.02.2026",
    "dueDate": "02.03.2026",
    "html": "<html>...",
    "pdf": "base64-encoded-pdf"
  },
  "emailSent": true,
  "emailError": null
}
```

## Требования

- Договор должен быть активным (`status: 'active'`)
- У арендатора должен быть указан email для отправки (опционально)
- Все данные договора, арендатора, юнита и объекта должны быть заполнены

## Примечания

- Счет формируется автоматически на основе данных из базы
- Номер счета уникален и содержит ID договора и timestamp
- PDF версия скачивается автоматически при формировании
- HTML версия открывается в новом окне браузера
- Email отправляется только если у арендатора указан email и включена опция отправки
